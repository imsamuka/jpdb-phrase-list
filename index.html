<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jpdb Phrase List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script> -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- <script src="https://unpkg.com/bz2"></script> -->

    <style>
        [x-cloak] {
            display: none;
        }
    </style>

    <script>
        function lerp(min, max, t) {
            return min * (1 - t) + max * t
        }
        function ilerp(min, max, v) {
            return (v - min) / (max - min)
        }
        function remap(iMin, iMax, oMin, oMax, v) {
            return lerp(oMin, oMax, ilerp(iMin, iMax, v))
        }
        function clampedRemap(iMin, iMax, oMin, oMax, v) {
            const r = remap(iMin, iMax, oMin, oMax, v)
            return (r < oMin) ? oMin : (r > oMax) ? oMax : r
        }

        /* async function loadSentences() {
            // const jpn_sentences_url = "https://downloads.tatoeba.org/exports/per_language/jpn/jpn_sentences.tsv.bz2"
            // const audio_sentences_url = "https://downloads.tatoeba.org/exports/sentences_with_audio.tar.bz2"

            try {
                const response = await fetch(jpn_sentences_url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch the file. Status: ${response.status}`);
                }

                // const bz2 = new BZip2()
                // await bz2.init()
                // const bytes = bz2.decompress(await response.arrayBuffer(), 20 * 1024 * 1024); // 20Mib?

                const bytes = bz2.decompress(new Uint8Array(await response.arrayBuffer()));

                const text = new TextDecoder('utf8').decode(bytes);
                const result = {}
                for (let line of text.split("\n")) {
                    const tsv = line.split("\t")
                    result[tsv[0]] = tsv[2]
                }
                return result
            } catch (error) {
                console.error("An error occurred:", error);
                return {}
            }
        } */

        const grades = { unknown: 0, known: 4, nothing: 1, something: 2, hard: 3, okay: 4, easy: 5 }

        function calculateAllGrasp(vocab_list) {
            for (let key in vocab_list) {
                const vocab = vocab_list[key]

                // These calculations are almost bullshit
                // but it should give us something to work with

                let e_factor = 2.5

                for (let { timestamp, grade } of vocab.reviews) {
                    let q = grades[grade]
                    if (q < 3) {
                        e_factor = 2.5
                        continue
                    }
                    e_factor += (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
                    if (e_factor < 1.3) e_factor = 1.3
                }

                vocab.grasp = clampedRemap(1.3, 3.0, 0.1, 0.9, e_factor);
            }
            vocab_list.sort((a, b) => a.grasp < b.grasp)
        }

        document.addEventListener('alpine:init', async () => (Alpine.data('state', () => ({
            vocab_list: [],
            all_sentences: {
                // populated with example sentences for testing
                1297: "きみにちょっとしたものをもってきたよ。",
                4702: "何かしてみましょう。",
                4703: "私は眠らなければなりません。",
                4704: "何してるの？",
                4705: "今日は６月１８日で、ムーリエルの誕生日です！",
                4706: "お誕生日おめでとうムーリエル！",
                4707: "ムーリエルは２０歳になりました。",
                4708: "パスワードは「Muiriel」です。",
                4709: "すぐに戻ります。",
                4710: "知らない。",
                4711: "何と言ったら良いか分かりません。",
                4712: "きりがない。",
                4713: "何と言ったらいいか・・・。",
                4714: "こいつは悪いウサギだった。",
                4715: "私は山にいました。",
                4716: "それは最近の写真？",
                4717: "時間があるか分かりません。",
                4718: "先程、どういうわけかマイクが入りませんでした。",
                4720: "この世界の教育にはがっかりしてしまう。",
                4726: "私は一日に100ユーロ稼ぎます。",
                4727: "すぐに諦めて昼寝をするかも知れない。",
            },
            min_grasp: 60,
            with_query: "",
            with_audio: true,
            sort_relevance: true,
            char_cap: true,
            from_native: false,
            // unknown_words: 0,

            filtered_vocab() {
                return this.vocab_list.filter((vocab) => (vocab.grasp * 100).toFixed(0) >= this.min_grasp)
            },

            tatoeba_search() {
                const url = new URL("https://tatoeba.org/en/sentences/search");

                url.searchParams.append("from", "jpn")
                url.searchParams.append("to", "eng")
                url.searchParams.append("trans_to", "eng")
                url.searchParams.append("word_count_min", "1")
                url.searchParams.append("word_count_max", this.char_cap ? "25" : "")

                url.searchParams.append("orphans", "no")
                url.searchParams.append("unapproved", "no")

                url.searchParams.append("has_audio", this.with_audio ? "yes" : "")
                url.searchParams.append("native", this.from_native ? "yes" : "")

                url.searchParams.append("tags", "")
                url.searchParams.append("sort", this.sort_relevance ? "relevance" : "random")
                url.searchParams.append("sort_reverse", "")
                url.searchParams.append("trans_filter", "limit")

                let query = this.filtered_vocab().map(
                    (vocab) => `(@text "${vocab.spelling}" @transcription "${vocab.reading}")`)
                query.sort(() => Math.random() - 0.5)
                query = query.join("|")
                let index = query.lastIndexOf("|", 500)
                if (index != -1) {
                    query = query.slice(0, index)
                }

                const with_query = this.with_query.split(" ")
                    .filter((s) => !!s).map((s) => '"' + s + '"').join(" ")

                url.searchParams.append("query", with_query + " " + query)

                return url

            },

            init() {
                this.vocab_list = JSON.parse(localStorage.getItem('vocab_list') || '[]')
                console.log(`loaded 'vocab_list' with ${Object.keys(this.vocab_list).length} cards`)
                console.log(this.vocab_list)

                /*
                let all_sentences = JSON.parse(localStorage.getItem('all_sentences') || '{}')
                console.log(all_sentences)
                if (!Object.keys(all_sentences).length) {
                    console.log("Downloading and decompressing 'all_sentences'...")
                    all_sentences = await loadSentences()
                    console.log(`Done. ${Object.keys(all_sentences).length} sentences`)
                    localStorage.setItem('all_sentences', JSON.stringify(all_sentences))
                    console.log(`Saved on localStorage`)
                } else {
                    console.log(`Loaded ${Object.keys(all_sentences).length} sentences from local storage.`)
                }
                this.all_sentences = all_sentences
                */
            }
        })
        )
        ))
    </script>
</head>

<body class="dark mb-5" x-data="state">
    <div class="container mt-3">
        <div class="row row-cols-1 row-cols-md-2">
            <div class="col">
                <h2 class="mb-3 mt-4 text-center">Configuration</h2>

                <div class="input-group mb-3">
                    <label class="input-group-text" for="fileUpload">Upload Reviews</label>
                    <input class="form-control" id="fileUpload" type="file" accept=".json,application/json" @input="
                        const parsed = JSON.parse(await $event.target.files[0].text() || '{}')
                        const new_vocab_list = parsed.cards_vocabulary_jp_en
                        if (new_vocab_list && Object.keys(new_vocab_list).length > 0) {
                            console.log('Updating stored \'new_vocab_list\'')
                            calculateAllGrasp(new_vocab_list)
                            localStorage.setItem('vocab_list', JSON.stringify(new_vocab_list))
                            vocab_list = new_vocab_list
                        }
                    ">

                    <button class="btn btn-outline-danger btn-sm"
                        @click="vocab_list = {}; localStorage.removeItem('vocab_list')">Delete Reviews</button>
                </div>

                <div class="input-group mb-3">
                    <label for="min_grasp" class="input-group-text">Words Minimum Grasp Level</label>
                    <input id="min_grasp" x-model="min_grasp" type="number" class="form-control" value="60" min="10"
                        max="90" step="5">
                    <span class="input-group-text">%</span>
                </div>

                <!-- <div class="input-group mb-3">
                    <label for="unknown_words" class="input-group-text">Unknown Words</label>
                    <input id="unknown_words" x-model="unknown_words" type="number" class="form-control" value="0"
                        min="0">
                </div> -->

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="with_audio" x-model="with_audio">
                    <label class="form-check-label" for="with_audio">Only with Audio</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="sort_relevance" x-model="sort_relevance">
                    <label class="form-check-label" for="sort_relevance">Sort by Relevance</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="char_cap" x-model="char_cap">
                    <label class="form-check-label" for="char_cap">25 Character Cap</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="from_native" x-model="from_native">
                    <label class="form-check-label" for="from_native">From Native</label>
                </div>

                <div class="search-bar mt-2">
                    <input type="text" x-model="with_query" class="form-control"
                        placeholder="Show Phrases Containing...">
                </div>
            </div>

            <div class="col">
                <h2 class="mb-3 mt-4 text-center">Stats</h2>

                <div class="input-group mb-3">
                    <label for="vocab_count" class="input-group-text">Total Vocabulary Count</label>
                    <input readonly id="vocab_count" :value="Object.keys(vocab_list).length" type="number"
                        class="form-control">
                </div>

                <div class="input-group mb-3">
                    <label for="sel_vocab_count" class="input-group-text">Selected Vocabulary Count</label>
                    <input readonly id="sel_vocab_count" :value="filtered_vocab().length" type="number"
                        class="form-control">
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <a class="btn btn-outline-primary btn-lg  w-25 my-3" :href="tatoeba_search()" target="_blank"
                @click="$event.target.href = tatoeba_search()">New Tatoeba Advanced Search</a>
        </div>

        <div class="row" x-data="{ open: true }" x-cloak>
            <h2 class="mb-3 mt-4 text-center">Vocabulary list</h2>
            <!-- <button :class="'my-3 w-25 mx-auto  btn btn-lg ' + (open ? 'btn-secondary' : 'btn-primary')"
                @click="open = !open" x-text="open ? 'Hide' : 'Show'"></button> -->
            <div x-show="open" class="row row-cols-1 row-cols-md-6 g-2">
                <template x-for="vocab in vocab_list">
                    <div class="col">
                        <div
                            :class="'h-100 card ' + ((vocab.grasp * 100).toFixed(0) >= min_grasp ? 'border-success' : 'border-danger')">
                            <div class="card-body row text-center">
                                <ruby class="fs-3">
                                    <a class="card-text link-underline link-underline-opacity-0" x-text="vocab.spelling"
                                        :href="'https://jpdb.io/vocabulary/' + vocab.vid + '/' + vocab.spelling"></a>
                                    <rp>(</rp>
                                    <rt x-show="vocab.reading != vocab.spelling" x-text="vocab.reading"></rt>
                                    <rp>)</rp>
                                </ruby>
                                <p class="fs-4 align-middle" x-text="`${parseFloat(vocab.grasp * 100).toFixed(0)}%`">
                                </p>
                                <button class="btn btn-outline-secondary mx-auto w-50 btn-sm" @click="
                                    if (with_query.includes(vocab.spelling)) {
                                        with_query = with_query.replace(vocab.spelling, '').replace('  ', ' ').trim()
                                    } else {
                                        with_query += (with_query && ' ') + vocab.spelling
                                    }
                                " x-text="with_query.includes(vocab.spelling) ? 'Remove' : 'Add'">
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- <div class="row" x-show="false">
            <h2 class="mb-3 mt-4 text-center">Available Phrases</h2>
            <div class="row row-cols-auto g-1">
                <template x-for="key_sentence of Object.entries(all_sentences || {})">
                    <div class="col">
                        <div class="card" x-data="{ spelling: false }">
                            <div class="card-body link-underline-opacity-0">
                                <a class="card-text" x-text="key_sentence[1]"
                                    :href="'https://tatoeba.org/en/sentences/show/' + key_sentence[0]"></a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div> -->
    </div>
</body>

</html>
